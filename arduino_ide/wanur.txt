#include <Arduino.h>
#include <WiFi.h>
#include <WiFiClientSecure.h>

// ==========================================
// 1. CONFIG
// ==========================================
#define WIFI_SSID       "tethering"
#define WIFI_PASSWORD   "juljuljul"
// Pastikan URL diakhiri tanda miring "/"
#define DATABASE_URL    "https://wanur-glove-default-rtdb.firebaseio.com/" 
// MASUKKAN KODE RAHASIA DARI FIREBASE DISINI
#define DATABASE_SECRET "hedeS6C8sHsVN6DoPTZki7BDIYqkt7MAF3Af8qwZ" 

// ==========================================
// 2. LIBRARY (GANTI BAGIAN INI)
// ==========================================
#define ENABLE_DATABASE
#define ENABLE_LEGACY_TOKEN  // <--- GANTI DARI NO_AUTH JADI INI
#include <FirebaseClient.h>
#include <BleKeyboard.h>
#include <HX711.h>

// ==========================================
// 3. PINOUT
// ==========================================
#define LOADCELL_DOUT 6
#define LOADCELL_SCK  7
#define GRAVITY 9.8

#define ROW_PIN 4
int COL_PINS[4] = {10, 5, 3, 2}; 
char keymap[4] = {'f','g','h','j'}; 

// ==========================================
// 4. OBJEK GLOBAL
// ==========================================
HX711 scale;
WiFiClientSecure ssl;
using AsyncClient = AsyncClientClass;
AsyncClient aClient(ssl);

// GANTI AUTH MENJADI LEGACY TOKEN
LegacyToken auth(DATABASE_SECRET); 

FirebaseApp app;
RealtimeDatabase Database;
AsyncResult databaseResult; 

BleKeyboard bleKeyboard("WanurGlove-Controller", "ESP32C3", 100);

bool wifiConnected = false;
unsigned long lastFirebaseTime = 0;
unsigned long lastKeyTime[4] = {0,0,0,0};
unsigned long lastHeartbeat = 0;
bool giliranUpload = true; 

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("\n\n=== WanurGlove SYSTEM (SECURE MODE) ===");

  // --- 1. WIFI ---
  Serial.printf("[1] Menghubungkan ke: [%s]\n", WIFI_SSID);
  WiFi.mode(WIFI_STA);
  WiFi.disconnect(true);
  delay(500); 
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);

  int attempt = 0;
  while (WiFi.status() != WL_CONNECTED && attempt < 60) { 
    delay(500);
    Serial.print(".");
    attempt++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\n>>> SUKSES! WiFi Connected. <<<");
    Serial.print("IP: "); Serial.println(WiFi.localIP());
    wifiConnected = true;

    // --- SETUP FIREBASE ---
    ssl.setInsecure();
    initializeApp(aClient, app, getAuth(auth)); // Auth pakai Token Rahasia
    app.getApp<RealtimeDatabase>(Database);
    Database.url(DATABASE_URL);
    Serial.println("[2] Firebase Siap (Mode Legacy Token).");
  } else {
    Serial.println("\n[X] WiFi Gagal.");
    wifiConnected = false;
  }

  // --- 2. BLE ---
  bleKeyboard.begin();
  Serial.println("[3] BLE Keyboard Started.");

  // --- 3. LOADCELL ---
  scale.begin(LOADCELL_DOUT, LOADCELL_SCK);
  Serial.print("[4] Cek Loadcell... ");
  if (scale.wait_ready_timeout(1000)) {
      scale.tare();
      Serial.println("OK.");
  } else {
      Serial.println("SKIP.");
  }

  // --- 4. GPIO ---
  pinMode(ROW_PIN, OUTPUT);
  digitalWrite(ROW_PIN, LOW);
  for(int i=0; i<4; i++) pinMode(COL_PINS[i], INPUT_PULLUP);
  
  Serial.println("=== LOOP START ===");
}

// --- VARIABEL GLOBAL ---
bool isPending = false;        
unsigned long pendingStart = 0; 
int errorCount = 0;
bool expectingUpload = false; // VAR BARU: Penanda kita lagi ngapain

void loop() {
  // 1. JAGA KONEKSI WIFI
  wifiConnected = (WiFi.status() == WL_CONNECTED);

  if(wifiConnected) {
     app.loop();
     Database.loop();
  } else {
     isPending = false; 
  }

  // 2. DETAK JANTUNG
  if (millis() - lastHeartbeat > 1000) {
      lastHeartbeat = millis();
      Serial.print("."); 
  }

  // 3. BLE KEYBOARD
  for (int i = 0; i < 4; i++) {
    if (digitalRead(COL_PINS[i]) == LOW) {
      if (millis() - lastKeyTime[i] > 150) { 
        lastKeyTime[i] = millis();
        // Serial.printf("Key: %c\n", keymap[i]); // Debug
        if (bleKeyboard.isConnected()) bleKeyboard.write(keymap[i]);
      }
    }
  }

  // ============================================================
  // LOGIKA ANTRIAN PINTAR (FIX TABRAKAN DATA)
  // ============================================================
  
  // A. CEK HASIL (RESPON DITERIMA)
  if (wifiConnected && databaseResult.available()) {
    isPending = false; 
    errorCount = 0;
    
    if (databaseResult.isError()) {
        Serial.print("\n[X] Ditolak: ");
        Serial.println(databaseResult.error().message().c_str());
    } else {
       // KITA CEK: INI BALASAN UPLOAD ATAU DOWNLOAD?
       if (expectingUpload) {
           // Kalau ini balasan Upload, kita CUEKIN isinya. 
           // Yang penting sukses.
           Serial.println(" [OK] Data Force Terkirim!");
       } else {
           // Kalau ini balasan Download, baru kita baca isinya.
           String payload = String(databaseResult.c_str());
           payload.replace("\"", ""); 
           
           if (payload.length() == 4 && isalnum(payload[0])) {
              Serial.println(" [OK] Keymap Update: " + payload);
              for(int k=0; k<4; k++) keymap[k] = payload[k];
           }
       }
    }
  }

  // B. CEK TIMEOUT (JIKA MACET LEBIH DARI 10 DETIK)
  if (isPending && (millis() - pendingStart > 10000)) {
    Serial.print("\n[!] TIMEOUT: Jalur macet. ");
    Serial.println("Reset SSL...");
    ssl.stop(); // Paksa putus koneksi
    
    isPending = false; 
    giliranUpload = !giliranUpload; // Skip giliran ini
    
    errorCount++;
    if(errorCount > 5) {
        Serial.println(">>> TERLALU BANYAK ERROR, RECONNECT WIFI... <<<");
        WiFi.disconnect();
        WiFi.reconnect();
        errorCount = 0;
    }
  }

  // C. KIRIM DATA BARU (Interval 4 Detik)
  if (wifiConnected && app.ready() && !isPending && (millis() - lastFirebaseTime > 4000)) {
    lastFirebaseTime = millis();
    
    isPending = true;
    pendingStart = millis();

    if (giliranUpload) {
        // --- UPLOAD FORCE ---
        if (scale.is_ready()) {
            long raw = scale.get_units(1);
            int force = abs(raw * GRAVITY);
            
            Serial.printf("\n[UPLOAD >>] Kirim: %d...", force);
            
            // TANDAI BAHWA KITA LAGI UPLOAD
            expectingUpload = true; 
            
            Database.set<int>(aClient, "/status/force", force, databaseResult);
        } else {
            isPending = false; 
        }
    } else {
        // --- DOWNLOAD KEYMAP ---
        Serial.print("\n[<< DOWNLOAD] Cek Keymap...");
        
        // TANDAI BAHWA KITA LAGI DOWNLOAD
        expectingUpload = false;
        
        Database.get(aClient, "/config/keymap", databaseResult);
    }
    
    giliranUpload = !giliranUpload; 
  }
}